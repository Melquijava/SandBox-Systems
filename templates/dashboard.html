<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard - Systems_BSI Editor</title>
    <!-- Garante que o CSS correto da dashboard está sendo chamado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
  </head>
  <body>
    <header class="dashboard-header">
      <h1>Dashboard de Projetos</h1>
      <div class="user-info">
        <a href="{{ url_for('profile', username=username) }}" class="header-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          Perfil
        </a>
        <a href="{{ url_for('edit_profile') }}" class="header-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
          Editar
        </a>
        <span class="welcome-text">Olá, {{ username }}!</span>
        <a href="{{ url_for('logout') }}" class="header-link logout-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            Sair
        </a>
      </div>
    </header>

    <main class="dashboard-container">
      <a href="{{ url_for('editor') }}" class="new-project-button">+ Criar Novo Projeto</a>
      <h2>Meus Projetos</h2>
      <div class="project-grid">
        {% for project_id, project in projects.items() %}
          <!-- =============================================================== -->
          <!-- || A CORREÇÃO CRÍTICA ESTÁ NESTA LINHA: restaurando o data-project || -->
          <!-- =============================================================== -->
          <div class="project-card" data-project="{{ project|tojson|safe }}">
            <h3>{{ project.name }}</h3>

            <div class="preview-container">
              <iframe class="project-preview-frame" scrolling="no"></iframe>
            </div>

            <div class="likes-bar">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
              <span>0 Curtidas</span>
            </div>

            <div class="card-actions">
              <a href="{{ url_for('view', project_id=project_id) }}" target="_blank" class="action-button view-button">Ver</a>
              <a href="{{ url_for('editor') }}?project_id={{ project_id }}" class="action-button edit-button">Editar</a>
              <button class="action-button share-button" data-link="{{ url_for('view', project_id=project_id, _external=True) }}">Compartilhar</button>
              <button class="action-button delete-button" data-project-id="{{ project_id }}">Excluir</button>
            </div>
          </div>
        {% else %}
          <p>Você ainda não tem projetos salvos. Crie um novo!</p>
        {% endfor %}
      </div>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Script para renderizar as prévias (agora vai funcionar)
        document.querySelectorAll('.project-card').forEach((card) => {
          const iframe = card.querySelector('.project-preview-frame');
          const projectDataString = card.dataset.project; // Esta linha agora encontrará os dados
          if (iframe && projectDataString) {
            try {
              const projectData = JSON.parse(projectDataString);
              const previewDoc = iframe.contentDocument || iframe.contentWindow.document;
              previewDoc.open();
              previewDoc.write(`
                <html>
                <head><style>${projectData.css}</style></head>
                <body style="transform: scale(0.5); transform-origin: top left; width: 200%; height: 200%; overflow: hidden;">${projectData.html}</body>
                </html>
              `);
              previewDoc.close();
            } catch(e) { console.error('Erro ao renderizar prévia do projeto:', e); }
          }
        });
      
        // Script para os botões de ação
        document.querySelector('.project-grid').addEventListener('click', async (e) => {
          const button = e.target.closest('.action-button');
          if (!button) return;

          if (button.classList.contains('share-button')) {
            const link = button.dataset.link;
            navigator.clipboard.writeText(link).then(() => {
              const originalText = button.textContent;
              button.textContent = 'Copiado!';
              setTimeout(() => { button.textContent = 'Compartilhar'; }, 2000);
            }).catch(err => console.error('Erro ao copiar link:', err));
          }

          if (button.classList.contains('delete-button')) {
            const projectId = button.dataset.projectId;
            if (confirm('Tem certeza que deseja excluir este projeto?')) {
              try {
                const response = await fetch(`/api/projects/${projectId}`, { method: 'DELETE' });
                if (response.ok) {
                  button.closest('.project-card').remove();
                } else {
                  alert('Erro ao excluir o projeto.');
                }
              } catch (error) {
                alert('Erro de conexão ao tentar excluir.');
              }
            }
          }
        });
      });
    </script>
  </body>
</html>